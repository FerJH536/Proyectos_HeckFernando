<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sistema de Gestión de Productos</title>

<style>
    body {
        font-family: 'Segoe UI', sans-serif;
        background: linear-gradient(135deg, #0a192f, #112240);
        color: #e6f1ff;
        margin: 0;
        padding: 30px;
    }

    h2 {
        text-align: center;
        color: #64ffda;
        margin-bottom: 30px;
    }

    .stats {
        text-align: center;
        margin-bottom: 20px;
        color: #8892b0;
    }

    .filtros {
        background: #112240;
        padding: 20px;
        border-radius: 12px;
        margin-bottom: 25px;
        box-shadow: 0 0 10px rgba(0,0,0,0.4);
    }

    .filtro-grupo {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
    }

    label {
        color: #ccd6f6;
        font-weight: bold;
        flex: 1;
    }

    input, select {
        flex: 2;
        padding: 8px;
        border-radius: 8px;
        border: none;
        outline: none;
        background: #0a192f;
        color: #fff;
    }

    button {
        background: #64ffda;
        border: none;
        padding: 10px 20px;
        border-radius: 8px;
        cursor: pointer;
        color: #0a192f;
        font-weight: bold;
        margin-right: 10px;
        transition: all 0.3s ease;
    }

    button:hover {
        background: #52e0c4;
    }

    table {
        width: 100%;
        border-collapse: collapse;
        background: #112240;
        border-radius: 12px;
        overflow: hidden;
    }

    th, td {
        padding: 12px;
        text-align: left;
    }

    th {
        background: #0a192f;
        color: #64ffda;
    }

    tr:nth-child(even) {
        background: #0d1b2a;
    }

    tr:hover {
        background: #1b2a41;
    }

    #mensaje {
        text-align: center;
        color: #64ffda;
        margin-top: 20px;
    }
</style>
</head>

<body>
    <h2>Sistema de Gestión de Productos</h2>

    <div class="stats">
        Total de productos: <span id="totalProductos">0</span> |
        Valor total stock: $<span id="valorTotal">0</span>
    </div>

    <div class="filtros">
        <div class="filtro-grupo">
            <label>Buscar:</label>
            <input type="text" id="buscar" placeholder="Buscar por nombre...">
        </div>

        <div class="filtro-grupo">
            <label>Categoría:</label>
            <select id="categoria">
                <option value="todas">Todas</option>
                <!--<option value="Electronica">Electrónica</option>
                <option value="Vestimenta">Vestimenta</option>-->
            </select>
        </div>

        <button id="aplicarFiltros">Aplicar filtros</button>
        <button id="limpiarFiltros">Limpiar</button>
    </div>

    <table>
        <thead>
            <tr>
                <th>ID</th>
                <th>Nombre</th>
                <th>Categoría</th>
                <th>Precio</th>
                <th>Stock</th>
                <th>Valor Total</th>
            </tr>
        </thead>
        <tbody id="cuerpoTabla"></tbody>
    </table>

    <p id="mensaje"></p>

    <h3>Agregar / Editar Producto</h3>
<div class="filtros">
    <input type="hidden" id="idProducto">

    <div class="filtro-grupo">
        <label>Nombre:</label>
        <input type="text" id="nombre_producto">
    </div>

    <div class="filtro-grupo">
        <label>Categoría:</label>
        <input type="text" id="categoriaInput">
        <!--<select id="categoriaInput">
            <option value="Electronica">Electrónica</option>
            <option value="Vestimenta">Vestimenta</option>-->
    </div>

    <div class="filtro-grupo">
        <label>Precio:</label>
        <input type="number" id="precio" step="0.01">
    </div>

    <div class="filtro-grupo">
        <label>Stock:</label>
        <input type="number" id="stock">
    </div>

    <button id="btnGuardar">Guardar</button>
    <button id="btnEliminar">Eliminar</button>
</div>


<script>
let productos = [];
let productosFiltrados = [];

// Cargar productos desde el backend
function cargarProductos() {
    fetch("obtener.php")
        .then(res => res.json())
        .then(data => {
            productos = data;
            productosFiltrados = [...productos];
            mostrarProductos(productos);
            actualizarCategorias(productos);
        })
        .catch(err => console.error("Error al obtener productos:", err));
}

/*function parsePrecio(valor) {
    if (valor === null || valor === undefined || valor === "") return 0;

    // Si ya es number, devolvemos tal cual
    if (typeof valor === "number" && !isNaN(valor)) return valor;

    // Convertir a string y limpiar espacios
    let s = String(valor).trim();

    // Eliminar símbolo de moneda (ej: $) y cualquier letra
    s = s.replace(/[^\d.,-]/g, "");

    // Si hay tanto puntos como comas, asumimos que los puntos son separadores de miles
    // y la coma es separador decimal: "29.999,99" -> "29999.99"
    if (s.indexOf(".") !== -1 && s.indexOf(",") !== -1) {
        s = s.replace(/\./g, "");    // quitar puntos (miles)
        s = s.replace(/,/g, ".");    // convertir coma decimal a punto
    } else {
        // Si solo tiene comas (ej "29999,99") -> convertir coma a punto
        if (s.indexOf(",") !== -1 && s.indexOf(".") === -1) {
            s = s.replace(/,/g, ".");
        }
        // Si solo tiene puntos como separador decimal (ej "29999.99"), queda igual
        // Si puntos como miles sin coma decimal (ej "29.999") -> quitar puntos
        // Para detectar esto: si hay puntos y los grupos de la derecha no son 2 dígitos decimales
        if (s.indexOf(".") !== -1) {
            const partes = s.split(".");
            const ult = partes[partes.length - 1];
            // si la última parte no tiene 2 dígitos (o tiene 3 = probablemente miles), quitamos puntos
            if (ult.length !== 2) {
                s = s.replace(/\./g, "");
            }
        }
    }

    const n = parseFloat(s);
    return isNaN(n) ? 0 : n;
}*/

// Mostrar productos en la tabla
function mostrarProductos(productos) {
    const cuerpo = document.getElementById("cuerpoTabla");
    cuerpo.innerHTML = "";

    if (productos.length === 0) {
        cuerpo.innerHTML = `<tr><td colspan="6" style="text-align:center;">No se encontraron productos.</td></tr>`;
        document.getElementById("totalProductos").textContent = 0;
        document.getElementById("valorTotal").textContent = 0;
        return;
    }

    productos.forEach(p => {
        const fila = document.createElement("tr");
        fila.innerHTML = `
            <td>${p.IdProducto}</td>
            <td>${p.nombre_producto}</td>
            <td>${p.categoria}</td>
            <td>$${parseFloat(p.precio).toLocaleString()}</td>
            <td>${p.stock}</td>
            <td>$${(p.precio * p.stock).toLocaleString()}</td>
        `;

        fila.addEventListener("click", () => {
            console.log("DEBUG -> p.precio raw:", p.precio, "tipo:", typeof p.precio);
            productoSeleccionado = p; // Guardamos el producto original

            document.getElementById("nombre_producto").value = p.nombre_producto;
            document.getElementById("categoria").value = p.categoria;
            const precioNumerico = parseFloat(String(p.precio).replace(",", "."));
            document.getElementById("precio").value = precioNumerico.toFixed(2);
            document.getElementById("stock").value = p.stock;
        });

        cuerpo.appendChild(fila);
    });

    actualizarEstadisticas(productos);
}

function actualizarCategorias(productos) {
    const select = document.getElementById("categoria");
    const categorias = new Set(); // Evita duplicados

    productos.forEach(p => {
        if (p.categoria && p.categoria.trim() !== "") {
            categorias.add(p.categoria);
        }
    });

    // Limpiamos y agregamos la opción "todas"
    select.innerHTML = `<option value="todas">Todas</option>`;

    // Agregamos las categorías que hay en la base
    categorias.forEach(cat => {
        const option = document.createElement("option");
        option.value = cat;
        option.textContent = cat;
        select.appendChild(option);
    });
}

// Actualizar estadísticas
function actualizarEstadisticas(productos) {
    document.getElementById("totalProductos").textContent = productos.length;
    const total = productos.reduce((sum, p) => sum + (p.precio * p.stock), 0);
    document.getElementById("valorTotal").textContent = total.toLocaleString();
}

document.getElementById("aplicarFiltros").addEventListener("click", aplicarFiltros);

// Aplicar filtros
function aplicarFiltros() {
    const texto = document.getElementById("buscar").value.toLowerCase();
    const categoria = document.getElementById("categoria").value;

    productosFiltrados = productos.filter(p => {
        const coincideNombre = p.nombre_producto.toLowerCase().includes(texto);
        const coincideCategoria = categoria === "todas" || p.categoria === categoria;
        return coincideNombre && coincideCategoria;
    });

    mostrarProductos(productosFiltrados);
}

document.getElementById("btnGuardar").addEventListener("click", () => {
    const id = document.getElementById("idProducto").value;
    const producto = {
        IdProducto: id,
        nombre_producto: document.getElementById("nombre_producto").value,
        categoria: document.getElementById("categoriaInput").value,
        precio: parseFloat(document.getElementById("precio").value),
        stock: parseInt(document.getElementById("stock").value)
    };

    const url = id ? "actualizar.php" : "insertar.php";

    fetch(url, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(producto)
    })
    .then(res => res.json())
    .then(res => {
        alert(res.message);
        cargarProductos();
        limpiarFormulario();
    });
});

document.getElementById("btnEliminar").addEventListener("click", () => {
    const id = document.getElementById("idProducto").value;
    if (!id) {
        alert("Selecciona un producto primero");
        return;
    }

    if (confirm("¿Seguro que deseas eliminar este producto?")) {
        fetch("eliminar.php", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ IdProducto: id })
        })
        .then(res => res.json())
        .then(res => {
            alert(res.message);
            cargarProductos();
            limpiarFormulario();
        });
    }
});

function limpiarFormulario() {
    document.getElementById("idProducto").value = "";
    document.getElementById("nombre_producto").value = "";
    document.getElementById("categoriaInput").value = "";
    document.getElementById("precio").value = "";
    document.getElementById("stock").value = "";
}

// Permitir seleccionar producto al hacer clic en la tabla
document.getElementById("cuerpoTabla").addEventListener("click", e => {
    const fila = e.target.closest("tr");
    if (!fila) return;

    const celdas = fila.querySelectorAll("td");
    document.getElementById("idProducto").value = celdas[0].textContent;
    document.getElementById("nombre_producto").value = celdas[1].textContent;
    document.getElementById("categoriaInput").value = celdas[2].textContent;
    document.getElementById("precio").value = parseFloat(celdas[3].textContent.replace("$","").replaceAll(",",""));
    document.getElementById("stock").value = celdas[4].textContent;
});

// Limpiar filtros
function limpiarFiltros() {
    document.getElementById("buscar").value = "";
    document.getElementById("categoria").value = "todas";
    productosFiltrados = [...productos];
    mostrarProductos(productosFiltrados);
}

// Eventos
document.getElementById("aplicarFiltros").addEventListener("click", aplicarFiltros);
document.getElementById("limpiarFiltros").addEventListener("click", limpiarFiltros);

// Inicialización
cargarProductos();
</script>
</body>
</html>
